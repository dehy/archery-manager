{% extends 'base.html.twig' %}

{% set licensee = licenseeHelper.licenseeFromSession %}
{% set license = licenseHelper.currentLicenseeCurrentLicense %}
{% set canAttend = licenseHelper.licenseIsValidForEvent(license, event) and date() < event.endsAt %}
{% set licenseeParticipation = eventHelper.licenseeParticipationToEvent(licensee, event) %}

{% block return_link %}
    {{ path('app_event_index') }}
{% endblock %}

{% block return_text %}
    Calendrier
{% endblock %}

{% block title %}
    {{ event.title }}
{% endblock %}

{% block body %}
    <!-- Hero Section -->
    <div class="event-hero mb-4">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-warning text-dark me-2 fs-6">
                        <i class="fa-solid fa-trophy me-1"></i>
                        Concours
                    </span>
                    <span class="badge bg-secondary">{{ event.discipline|readable_enum }}</span>
                    {% if date() < event.startsAt %}
                        <span class="badge bg-success ms-1">
                            <i class="fa-solid fa-door-open me-1"></i>
                            Inscriptions ouvertes
                        </span>
                    {% else %}
                        <span class="badge bg-danger ms-1">
                            <i class="fa-solid fa-door-closed me-1"></i>
                            Inscriptions fermées
                        </span>
                    {% endif %}
                </div>
                <h1 class="display-6 mb-2">{{ event.title }}</h1>
                <p class="text-muted mb-0">
                    <i class="fa-solid fa-calendar me-2"></i>
                    {{ event|event_date(diff=true) }}
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <a href="{{ path('app_event_ics', {slug: event.slug}) }}" class="btn btn-outline-primary me-2">
                    <i class="fa-solid fa-calendar-plus"></i>
                    Ajouter au calendrier
                </a>
                {% if licenseeParticipation and licenseeParticipation.participationState == constant('App\\DBAL\\Types\\EventParticipationStateType::NOT_GOING') %}
                    {% set participationButtonLabel = 'Absent•e' %}
                    {% set participationButtonColor = 'danger' %}
                    {% set participationIcon = 'user-xmark' %}
                {% elseif licenseeParticipation and licenseeParticipation.participationState == constant('App\\DBAL\\Types\\EventParticipationStateType::REGISTERED') %}
                    {% set participationButtonLabel = 'Inscrit•e' %}
                    {% set participationButtonColor = 'success' %}
                    {% set participationIcon = 'user-check' %}
                {% else %}
                    {% set participationButtonLabel = 'S\'inscrire' %}
                    {% set participationButtonColor = 'warning' %}
                    {% set participationIcon = 'user-plus' %}
                {% endif %}
                {% if not can_participate %}
                <span class="d-inline-block" 
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Cet événement est réservé à d'autres groupes">
                {% endif %}
                <button type="button" 
                        class="btn btn-{{ participationButtonColor }} {{ not canAttend or not can_participate ? 'disabled' }}"
                        {% if can_participate %}
                        data-bs-toggle="modal" 
                        data-bs-target="#participationModal"
                        {% endif %}
                        style="{{ not can_participate ? 'pointer-events: none;' : '' }}">
                    <i class="fa-solid fa-{{ participationIcon }} me-1"></i>
                    {{ participationButtonLabel }}
                </button>
                {% if not can_participate %}
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    {% if is_granted('ROLE_ADMIN') %}
        <!-- Admin Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning bg-warning bg-opacity-10">
                    <div class="card-body">
                        <h5 class="card-title text-warning">
                            <i class="fa-solid fa-screwdriver-wrench me-2"></i>
                            Administration
                        </h5>
                        <div class="btn-group me-2" role="group">
                            <a href="{{ path('app_admin_events_edit', {id: event.id}) }}" class="btn btn-warning btn-sm">
                                <i class="fa-solid fa-edit me-1"></i>
                                Modifier l'événement
                            </a>
                            <a href="{{
                            adminUrlGenerator
                                .setController('App\\Controller\\Admin\\' ~ event|get_short_class ~ 'CrudController')
                                .setAction('edit')
                                .setEntityId(event.id)
                            .generateUrl
                            }}" class="btn btn-outline-warning btn-sm">
                                <i class="fa-solid fa-cog me-1"></i>
                                EasyAdmin
                            </a>
                        </div>
                        <div class="btn-group me-2" role="group">
                            <a href="{{
                            adminUrlGenerator
                                .setController('App\\Controller\\Admin\\EventAttachmentCrudController')
                                .setAction('index')
                                .set('filters[event][comparison]', '=')
                                .set('filters[event][value]', event.id)
                            .generateUrl
                            }}" class="btn btn-outline-warning btn-sm">
                                <i class="fa-regular fa-file me-1"></i>
                                Pièces jointes
                            </a>
                            <a href="{{
                            adminUrlGenerator
                                .setController('App\\Controller\\Admin\\EventParticipationCrudController')
                                .setAction('index')
                                .set('filters[event][comparison]', '=')
                                .set('filters[event][value]', event.id)
                            .generateUrl
                            }}" class="btn btn-outline-warning btn-sm">
                                <i class="fa-solid fa-people-group me-1"></i>
                                Participations
                            </a>
                        </div>
                        <a href="{{
                        adminUrlGenerator
                            .setController('App\\Controller\\Admin\\ResultCrudController')
                            .setAction('index')
                            .set('filters[event][comparison]', '=')
                            .set('filters[event][value]', event.id)
                        .generateUrl
                        }}" class="btn btn-outline-warning btn-sm">
                            <i class="fa-solid fa-square-poll-vertical me-1"></i>
                            Résultats
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    {% if licenseeParticipation %}
        <!-- Participation Status Alerts -->
        <div class="row mb-4">
            <div class="col-12">
                {% if licenseeParticipation.participationState == constant('App\\DBAL\\Types\\EventParticipationStateType::INTERESTED') %}
                    <div class="alert alert-warning border-0 shadow-sm">
                        <i class="fa-solid fa-star me-2"></i>
                        Tu as indiqué être intéressé•e
                        {% if licenseeParticipation and licenseeParticipation.departure %}
                        pour le départ n°{{ licenseeParticipation.departure }}
                        {% endif %}.
                        Pense à faire ta demande d'inscription comme indiqué dans le mandat !
                    </div>
                {% endif %}
                {% if licenseeParticipation.participationState == constant('App\\DBAL\\Types\\EventParticipationStateType::REGISTERED') %}
                    <div class="alert alert-success border-0 shadow-sm">
                        <i class="fa-solid fa-check-circle me-2"></i>
                        Tu as indiqué t'être inscrit•e
                        {% if licenseeParticipation and licenseeParticipation.departure %}
                        au départ n°{{ licenseeParticipation.departure }}
                        {% endif %}.
                        N'oublie pas ta licence et de quoi régler l'inscription au greffe !
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Main Content Cards -->
    <div class="row">
        <!-- Event Details Card -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="fa-solid fa-info-circle text-warning me-2"></i>
                        Détails du concours
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="icon-box bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fa-solid fa-calendar text-warning"></i>
                                </div>
                                <div>
                                    <h6 class="fw-semibold mb-1">Date et heure</h6>
                                    <p class="text-muted mb-0">{{ event|event_date(diff=true) }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="icon-box bg-success bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fa-solid fa-bullseye text-success"></i>
                                </div>
                                <div>
                                    <h6 class="fw-semibold mb-1">Discipline</h6>
                                    <span class="badge bg-success">{{ event.discipline|readable_enum }}</span>
                                </div>
                            </div>
                        </div>
                        {% if event.assignedGroups is not empty %}
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="icon-box bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fa-solid fa-users text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="fw-semibold mb-1">Groupes autorisés</h6>
                                    {% for group in event.assignedGroups %}
                                        <span class="badge bg-primary me-1 mb-1">{{ group.name }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if event.address %}
                        <div class="col-12">
                            <div class="d-flex align-items-start">
                                <div class="icon-box bg-info bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fa-solid fa-map-marker-alt text-info"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-semibold mb-2">Lieu</h6>
                                    <address class="mb-2">{{ event.address }}</address>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline-info btn-sm dropdown-toggle"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fa-solid fa-external-link-alt me-1"></i>
                                            Ouvrir dans
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="https://maps.apple.com/?q={{ event.address|url_encode }}">
                                                    <i class="fa-brands fa-apple text-muted me-2"></i>
                                                    Apple Plans
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item"
                                                   href="https://www.google.com/maps/search/?api=1&query={{ event.address|url_encode }}">
                                                    <i class="fa-brands fa-google text-muted me-2"></i>
                                                    Google Maps
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item"
                                                   href="https://waze.com/ul?q={{ event.address|url_encode }}">
                                                    <i class="fa-brands fa-waze text-muted me-2"></i>
                                                    Waze
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Participants & Results Card -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="fa-solid fa-users text-warning me-2"></i>
                        Participants & Résultats
                    </h5>
                </div>
                <div class="card-body">
                    {% set participants = all_participants|filter(p => p.participationState is not same as constant('App\\DBAL\\Types\\EventParticipationStateType::NOT_GOING')) %}
                    
                    <div class="mb-4">
                        <h6 class="fw-semibold text-success mb-2">
                            <i class="fa-solid fa-user-check me-1"></i>
                            Inscrits ({{ participants|length }})
                        </h6>
                        {% if participants is not empty %}
                            <div class="participants-list">
                                {% for participant in participants|sort((a, b) => a.participant.fullname <=> b.participant.fullname) %}
                                    <span class="badge bg-success bg-opacity-10 text-success me-1 mb-1">
                                        {{ licensee_display_name(participant.participant) }}
                                        {% if participant.departure %}
                                            <small>(D{{ participant.departure }})</small>
                                        {% endif %}
                                    </span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted small mb-0">Aucun participant pour le moment</p>
                        {% endif %}
                    </div>

                    {% if event.results is not empty %}
                    <div>
                        <h6 class="fw-semibold text-primary mb-2">
                            <i class="fa-solid fa-trophy me-1"></i>
                            Résultats disponibles
                        </h6>
                        <a href="{{ path('app_event_results', {slug: event.slug}) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fa-solid fa-eye me-1"></i>
                            Voir les résultats
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Mandat et Résultats -->
    {% set showMandate = event.startsAt > date() %}
    {% set showResults = event.endsAt < date() %}
    
    <div class="row g-4 mt-4">
        <!-- Mandat -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-box bg-warning bg-opacity-10 text-warning me-3">
                            <i class="fa-regular fa-file"></i>
                        </div>
                        <h5 class="card-title mb-0">Mandat</h5>
                    </div>
                    
                    {% if event.attachments('mandate') is not empty %}
                        <div class="d-flex gap-2 mb-3">
                            <a href="{{ path('events_attachments_download', {attachment: (event.attachments('mandate')|first).id}) }}" 
                               class="btn btn-outline-primary btn-sm" target="_blank">
                                <i class="fa-solid fa-download me-1"></i>
                                Télécharger
                            </a>
                            {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('events_attachment_edit', {slug: event.slug, attachmentType: 'mandate'}) }}"
                                   class="btn btn-outline-warning btn-sm"
                                   data-action="modal#open"
                                   data-title="Mandat">
                                    <i class="fa-solid fa-arrows-rotate me-1"></i>
                                    Remplacer
                                </a>
                            {% endif %}
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <canvas data-pdf-url="{{ path('events_attachments_download', {'attachment': (event.attachments('mandate')|first).id }) }}">
                                Désolé, votre navigateur ne prend pas en charge le rendu de PDF.
                            </canvas>
                        </div>
                    {% else %}
                        <p class="text-muted fst-italic">Mandat non disponible.</p>
                        {% if is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('events_attachment_edit', {slug: event.slug, attachmentType: 'mandate'}) }}"
                               class="btn btn-outline-warning"
                               data-action="modal#open"
                               data-title="Ajout d'un mandat">
                                <i class="fa-solid fa-plus me-1"></i>
                                Ajouter un mandat
                            </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Résultats -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-box bg-success bg-opacity-10 text-success me-3">
                            <i class="fa-solid fa-trophy"></i>
                        </div>
                        <h5 class="card-title mb-0">Résultats</h5>
                    </div>

                    {% if is_granted('ROLE_ADMIN') %}
                        <div class="d-flex gap-2 mb-3">
                            <a href="{{ path('app_event_resultsedit', {slug: event.slug}) }}"
                               class="btn btn-outline-primary btn-sm"
                               data-action="modal#open"
                               data-title="Édition des résultats">
                                <i class="fa-solid fa-pencil me-1"></i>
                                Modifier
                            </a>
                            <a href="{{ path('events_attachment_edit', {slug: event.slug, attachmentType: 'results'}) }}"
                               class="btn btn-outline-warning btn-sm"
                               data-action="modal#open"
                               data-title="Téléversement des résultats">
                                <i class="fa-solid fa-upload me-1"></i>
                                Téléverser PDF
                            </a>
                            {% if event.attachments('results') is not empty %}
                                <a href="{{ path('events_attachments_download', {'attachment': (event.attachments('results')|first).id }) }}"
                                   class="btn btn-outline-success btn-sm" target="_blank">
                                    <i class="fa-solid fa-download me-1"></i>
                                    Télécharger PDF
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if event.results is not empty %}
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Participant</th>
                                        <th>Score</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in event.results|sort((a, b) => a.licensee.firstname <=> b.licensee.firstname) %}
                                        <tr data-bs-toggle="tooltip"
                                            title="{{ result.activity|readable_enum }}, {{ result.distance }}m, {{ result.targetType|readable_enum }} {{ result.targetSize }}cm">
                                            <td>{{ result.licensee.firstnameWithInitial }}</td>
                                            <td><strong>{{ result.total }}</strong></td>
                                            <td>
                                                <i class="fa-solid fa-info-circle text-muted"></i>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted fst-italic">Résultats indisponibles.</p>
                    {% endif %}

                    {% if event.attachments('results') is not empty %}
                        <hr>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <canvas data-pdf-url="{{ path('events_attachments_download', {'attachment': (event.attachments('results')|first).id }) }}">
                                Désolé, votre navigateur ne prend pas en charge le rendu de PDF.
                            </canvas>
                        </div>
                    {% elseif is_granted('ROLE_ADMIN') and event.results is empty %}
                        <a href="{{ path('events_attachment_edit', {slug: event.slug, attachmentType: 'results'}) }}"
                           class="btn btn-outline-success"
                           data-action="modal#open"
                           data-title="Ajout des résultats en PDF">
                            <i class="fa-solid fa-plus me-1"></i>
                            Ajouter un PDF
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Participation Modal -->
    {% include 'event/_participation_modal.html.twig' with {
        'event': event,
        'event_participation_form': event_participation_form
    } %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('events_show') }}
{% endblock %}